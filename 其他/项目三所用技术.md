# 记录

## 1. mybatis-plus

> 概念

​	MyBatis-Plus（简称 MP）是一个 MyBatis 的增强工具，在 MyBatis 的基础上只做增强不做改变，为简化开发、提高效率而生。

结构:

我们的微服务要生成代码，也要连接数据库，需要集成MyBatis-Plus,同时我们需要搭建一个代码生成器模块，它需要集成Mybatis-plus和Velocity

![image-20211121171439990](https://gitee.com/miawei/pic-go-img/raw/master/imgs/image-20211121171439990.png)

> 实战

新建一个微服务:hrm-basic-code-create

1. 导入依赖:

   ```xml-dtd
   <dependencies>
           <!--mybatis-plus驱动-->
           <dependency>
               <groupId>com.baomidou</groupId>
               <artifactId>mybatis-plus-boot-starter</artifactId>
               <version>2.2.0</version>
           </dependency>
           <!--模板引擎-->
           <dependency>
               <groupId>org.apache.velocity</groupId>
               <artifactId>velocity-engine-core</artifactId>
               <version>2.0</version>
           </dependency>
           <!--导入MySQL驱动-->
           <dependency>
               <groupId>mysql</groupId>
               <artifactId>mysql-connector-java</artifactId>
           </dependency>
       </dependencies>
   ```

2. 在resource下创建文件`mybatiesplus-config-system.properties`

   ```properties
   #代码输出基本路径
   OutputDir=F:/springcloud-hrm/hrm-system/hrm-service-system/src/main/java
   
   #mapper.xml SQL映射文件目录
   OutputDirXml=F:/springcloud-hrm/hrm-system/hrm-service-system/src/main/resources
   
   #domain的输出路径
   OutputDirBase=F:/springcloud-hrm/hrm-system/hrm-common-system/src/main/java
   
   #设置作者
   author=MiaoDaWei
   
   #自定义包路径:基础包的路径
   parent=cn.miao.hrm
   
   #数据库连接信息
   jdbc.driver=com.mysql.jdbc.Driver
   jdbc.url=jdbc:mysql://localhost:3306/hrm-system?userUnicode=true&characterEncoding=utf-8&serverTimezone=UTC
   jdbc.user=root
   jdbc.pwd=root
   ```

3. 新建代码生成类`GenteratorCode`:

   ```java
   package cn.miao;
   
   import com.baomidou.mybatisplus.generator.AutoGenerator;
   import com.baomidou.mybatisplus.generator.InjectionConfig;
   import com.baomidou.mybatisplus.generator.config.*;
   import com.baomidou.mybatisplus.generator.config.converts.MySqlTypeConvert;
   import com.baomidou.mybatisplus.generator.config.po.TableInfo;
   import com.baomidou.mybatisplus.generator.config.rules.DbType;
   import com.baomidou.mybatisplus.generator.config.rules.NamingStrategy;
   
   import java.util.*;
   
   /**
    * 生成代码的主类
    */
   public class GenteratorCode {
   
       public static void main(String[] args) throws InterruptedException {
           //用来获取Mybatis-Plus.properties文件的配置信息
           //不要加后缀
           ResourceBundle rb = ResourceBundle.getBundle("mybatiesplus-config-system");
           AutoGenerator mpg = new AutoGenerator();
           // 全局配置
           //代码输出基本路径
           GlobalConfig gc = new GlobalConfig();
           gc.setOutputDir(rb.getString("OutputDir"));
           gc.setFileOverride(false);
           // 开启 activeRecord 模式
           gc.setActiveRecord(true);
           // XML 二级缓存
           gc.setEnableCache(false);
           // XML ResultMap
           gc.setBaseResultMap(true);
           // XML columList
           gc.setBaseColumnList(false);
           gc.setAuthor(rb.getString("author"));
           mpg.setGlobalConfig(gc);
           // 数据源配置
           DataSourceConfig dsc = new DataSourceConfig();
           dsc.setDbType(DbType.MYSQL);
           dsc.setTypeConvert(new MySqlTypeConvert());
           dsc.setDriverName(rb.getString("jdbc.driver"));
           dsc.setUsername(rb.getString("jdbc.user"));
           dsc.setPassword(rb.getString("jdbc.pwd"));
           dsc.setUrl(rb.getString("jdbc.url"));
           mpg.setDataSource(dsc);
           // 表策略配置
           StrategyConfig strategy = new StrategyConfig();
           // 此处可以修改为您的表前缀
           strategy.setTablePrefix(new String[] { "t_" });
           strategy.setNaming(NamingStrategy.underline_to_camel);// 表名生成策略
   
           strategy.setInclude(new String[]{
                   "t_config",
                   "t_department",
                   "t_employee",
                   "t_operation_log",
                   "t_tenant",
                   "t_tenant_type"
           }); // 需要生成的表
   
           mpg.setStrategy(strategy);
           // 包配置
           PackageConfig pc = new PackageConfig();
           //cn.miao.hrm
           pc.setParent(rb.getString("parent"));
           //cn.miao.hrm.controller
           pc.setController("controller");
           pc.setService("service");
           pc.setServiceImpl("service.impl");
           pc.setEntity("domain");
           pc.setMapper("mapper");
           mpg.setPackageInfo(pc);
   
           // 注入自定义配置，可以在 VM 中使用 cfg.abc 【可无】
           InjectionConfig cfg = new InjectionConfig() {
               @Override
               public void initMap() {
                   Map<String, Object> map = new HashMap<String, Object>();
                   map.put("abc", this.getConfig().getGlobalConfig().getAuthor() + "-rb");
                   this.setMap(map);
               }
           };
   
           List<FileOutConfig> focList = new ArrayList<FileOutConfig>();
   
           //controller的输出配置
           focList.add(new FileOutConfig("/templates/controller.java.vm") {
               @Override
               public String outputFile(TableInfo tableInfo) {
                   //合并好的内容输出到哪儿？
                   return rb.getString("OutputDir")+ "/cn/miao/hrm/controller/" + tableInfo.getEntityName() + "Controller.java";
               }
           });
           //query的输出配置
           focList.add(new FileOutConfig("/templates/query.java.vm") {
               @Override
               public String outputFile(TableInfo tableInfo) {
                   return rb.getString("OutputDirBase")+ "/cn/miao/hrm/query/" + tableInfo.getEntityName() + "Query.java";
               }
           });
   
           // 调整 domain 生成目录演示
           focList.add(new FileOutConfig("/templates/entity.java.vm") {
               @Override
               public String outputFile(TableInfo tableInfo) {
                   return rb.getString("OutputDirBase")+ "/cn/miao/hrm/domain/" + tableInfo.getEntityName() + ".java";
               }
           });
   
           // 调整 xml 生成目录演示
           focList.add(new FileOutConfig("/templates/mapper.xml.vm") {
               @Override
               public String outputFile(TableInfo tableInfo) {
                   return rb.getString("OutputDirXml")+ "/cn/miao/hrm/mapper/" + tableInfo.getEntityName() + "Mapper.xml";
               }
           });
           cfg.setFileOutConfigList(focList);
           mpg.setCfg(cfg);
   
           // 自定义模板配置，可以 copy 源码 mybatis-plus/src/main/resources/templates 下面内容修改，
           // 放置自己项目的 src/main/resources/templates 目录下, 默认名称一下可以不配置，也可以自定义模板名称
           TemplateConfig tc = new TemplateConfig();
           tc.setService("/templates/service.java.vm");
           tc.setServiceImpl("/templates/serviceImpl.java.vm");
           tc.setMapper("/templates/mapper.java.vm");
           tc.setEntity(null);
           tc.setController(null);
           tc.setXml(null);
           // 如上任何一个模块如果设置 空 OR Null 将不生成该模块。
           mpg.setTemplate(tc);
   
           // 执行生成
           mpg.execute();
       }
   }
   ```

4. 导入我们自己的生成模板,在`resources\templates`

   1. controller.java.vm

      ```java
      package ${package.Controller};
      
      import ${package.Service}.${table.serviceName};
      import ${package.Entity}.${entity};
      import cn.miao.hrm.query.${entity}Query;
      import cn.miao.hrm.util.AjaxResult;
      import cn.miao.hrm.util.PageList;
      import com.baomidou.mybatisplus.plugins.Page;
      import org.springframework.beans.factory.annotation.Autowired;
      import org.springframework.web.bind.annotation.*;
      
      import java.util.List;
      
      @RestController
      @RequestMapping("/${table.entityPath}")
      public class ${entity}Controller {
          @Autowired
          public ${table.serviceName} ${table.entityPath}Service;
      
          /**
          * 保存和修改
          */
          @RequestMapping(value="/save",method= RequestMethod.POST)
          public AjaxResult save(@RequestBody ${entity} ${table.entityPath}){
              if(${table.entityPath}.getId()!=null){
                  ${table.entityPath}Service.updateById(${table.entityPath});
              }else{
                  ${table.entityPath}Service.insert(${table.entityPath});
              }
              return AjaxResult.me();
          }
      
          /**
          * 删除对象
          */
          @RequestMapping(value="/{id}",method=RequestMethod.DELETE)
          public AjaxResult delete(@PathVariable("id") Long id){
              ${table.entityPath}Service.deleteById(id);
              return AjaxResult.me();
          }
      
         /**
         * 根据ID获取对象
         */
          @RequestMapping(value = "/{id}",method = RequestMethod.GET)
          public AjaxResult get(@PathVariable("id")Long id){
              return AjaxResult.me().setResultObj(${table.entityPath}Service.selectById(id));
          }
      
      
          /**
          * 获取所有对象
          */
          @RequestMapping(value = "/list",method = RequestMethod.GET)
          public AjaxResult list(){
              return AjaxResult.me().setResultObj(${table.entityPath}Service.selectList(null));
          }
      
          /**
          * 分页查询数据
          */
          @RequestMapping(value = "/pagelist",method = RequestMethod.POST)
          public AjaxResult json(@RequestBody ${entity}Query query){
              Page<${entity}> page = new Page<${entity}>(query.getPage(),query.getRows());
              page = ${table.entityPath}Service.selectPage(page);
              PageList pageList = new PageList<${entity}>(page.getTotal(),page.getRecords());
              return AjaxResult.me().setResultObj(pageList);
          }
      }
      ```

   2. query.java.vm

      ```java
      package cn.miao.hrm.query;
      /**
       *
       * @author ${author}
       * @since ${date}
       */
      public class ${table.entityName}Query extends BaseQuery{
      }
      ```

   > 代码生成后就可以直接使用了